<!doctype html>

<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>Validador de ruts.</title>

<p>
  Copie y pegue un texto que contenga ruts.
  Yo le dir&eacute; si est&aacute;n correctos.
</p>

<textarea id="entrada" placeholder="Pegue aqu&iacute;">
</textarea>
<br>

<input id="validar" value="Validar" type="button">
<input id="borrar"  value="Borrar"  type="button">

<p id="reporte">
</p>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
</script>

<script>
    $("#borrar").on("click", function() {
        $("#entrada").val('');
    });

    function extraer_ruts() {
      var rut_re = /\d{1,2}[.]?\d{3}[.]?\d{3}-[0-9kK]/g;

      var resultados = [], calce;
      var texto = $("#entrada").val();
      while ((calce = rut_re.exec(texto)) !== null) {
        resultados.push(calce[0]);
      }
      return resultados;
    }

    function normalizar_rut(rut) {
      return rut.replace(/[.]/g, '').replace('K', 'k')
    }

    function validar_rut(rut) {
      var r = normalizar_rut(rut);
      var partes = r.split('-');
      var cifras = partes[0].split('');
      var dv_original = partes[1];

      var factor = 2;
      var suma = 0;
      var cifra;
      for (var i = cifras.length - 1; i >= 0; i--, factor++) {
        factor = factor > 7 ? 2 : factor;
        cifra = parseInt(cifras[i]);
        suma += cifra * factor;
        //console.log(cifra.toString() + ' * ' + factor.toString())
      }
      var dv_calculado = (11 - (suma % 11)) % 11;
      if (dv_calculado === 10) {
        dv_calculado = 'k';
      } else {
        dv_calculado = dv_calculado.toString();
      }

      return {
        original: dv_original,
        calculado: dv_calculado,
        valido: dv_original === dv_calculado,
      }
    }

    $("#validar").on("click", function() {
      var ruts = extraer_ruts();
      var reporte = $("#reporte");
      reporte.html(function (i, old_html) {
        return old_html + '<hr>';
      });
      $.each(ruts, function (index, rut) {
        reporte.html(function (i, old_html) {
          return old_html + normalizar_rut(rut) + '<br>';
        });
      });
    });

</script>

